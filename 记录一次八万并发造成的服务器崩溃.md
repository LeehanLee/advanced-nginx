**（未完成）**

天猫双11活动，我们商城推出了1.1元11个G的流量活动，这个页面在淘宝双11页面推广，边缘服务器是四层代理array硬件服务器，array代理到后端8台nginx+PHP-FPM服务器

由于本人没有参与本次开发与稳定维护值班，所以只能通过后续过滤nginx日志来进行整理

nginx进程为16，PHP-FPM进程384，两者backlog都为1000

```
  array -> 负载均衡请求8台nginx -> nginx -> nginx请求本地9000端口PHP-FPM -> php请求内网的31个省公司办理中间件系统
```

nginx部分的php-fpm配置如下：
```
access_log /home/aspire/logs/m/nginx/m.access.log aspire buffer=32k;
worker_processes  16;
events {
    worker_connections  65535;
}
keepalive_timeout  30;
sendfile  on;
error_page 404 = /err/404.php;
error_page 500 = /err/busy.html;
error_page 502 = /err/busy.html;
error_page 503 = /err/busy.html;
error_page 504 = /err/busy.html;
location ~ \.php$ {
		try_files $uri =404;
		fastcgi_buffer_size 128k;
		fastcgi_buffers 32 32k;
		root           $root;
		fastcgi_pass   127.0.0.1:9000;
		fastcgi_index  index.php;
		fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
		include        fastcgi_params;
	}
```
nginx的fastcgi配置如下，就是nginx的默认配置：
```
fastcgi_param  QUERY_STRING       $query_string;
fastcgi_param  REQUEST_METHOD     $request_method;
fastcgi_param  CONTENT_TYPE       $content_type;
fastcgi_param  CONTENT_LENGTH     $content_length;
fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;
fastcgi_param  REQUEST_URI        $request_uri;
fastcgi_param  DOCUMENT_URI       $document_uri;
fastcgi_param  DOCUMENT_ROOT      $document_root;
fastcgi_param  SERVER_PROTOCOL    $server_protocol;
fastcgi_param  HTTPS              $https if_not_empty;
fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;
fastcgi_param  SERVER_SOFTWARE    nginx/$nginx_version;
fastcgi_param  REMOTE_ADDR        $remote_addr;
fastcgi_param  REMOTE_PORT        $remote_port;
fastcgi_param  SERVER_ADDR        $server_addr;
fastcgi_param  SERVER_PORT        $server_port;
fastcgi_param  SERVER_NAME        $server_name;
# PHP only, required if PHP was built with --enable-force-cgi-redirect
fastcgi_param  REDIRECT_STATUS    200;
```
活动早10点开始，此时array并发数量达到8万，再次访问直接白页，一直刷不出页面

根据后续过滤nginx的access日志，单台业务服务器10点到11点请求数为160万，其中
- http_code 200的为1041172
- http_code 302的为457230
- http_code 499的为110196
- http_code 为502的为7
- http_code 为504的为37
- http_code 为304的为241
- http_code 为403的为33

**http_code为403**
  造成这个响应码的原因为业务代码ajax请求到PHP，PHP会判断有没有登录信息，没有就直接返回403，日志中也全是uri为ajax的，所以这些日志总体来说请求正常，业务异常
  
**http_code为504**
  造成这个响应码的原因为客户端请求服务器图片，传输造成超时，总体来说不影响请求
  
